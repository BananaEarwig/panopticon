#include <gtest/gtest.h>

#include <panopticon/amd64/amd64.hh>

using namespace po;

TEST(amd64,simple)
{
	//region_loc reg = region::wrap("ram",{0x37,0xd5,0x0a,0xd5,0x33,0xd4,0x0a,0xd4,0x55,0x3f});
	//region_loc reg = region::wrap("ram",{0x14,0x06,0x66,0x83,0xd0,0x2c,0x15,0x20,0x02,0x00,0x00,0x48,0x15,0xba,0xfe,0xe7,0x03});
	region_loc reg = region::wrap("ram",{
		0x14,0x06,0x66,0x83,0xd0,0x2c,0x15,0x20,0x02,0x00,0x00,0x48,0x15,0xba,0xfe,0xe7,0x03,0x48,0x15,0xba,0xfe,0xe7,0x03,0x10,0xd8,0x66,0x11,0xd8,0x11,0xd8,0x48,0x11,0xd8,0x10,0x1c,0x25,0x44,0x33,0x22,0x11,0x66,0x11,0x1c,0x25,0x11,0x22,0x33,0x44,0x67,0x11,0x18,0x48,0x11,0x1c,0x25,0xa1,0x1a,0x00,0x00
	});
/*		0x14,0x06,
		0x66,0x83,0xd0,0x2c,
		0x15,0x20,0x02,0x00,0x00,
		0x48,0x15,0xba,0xfe,0xe7,0x03,0x10,0xd8,0x66,0x11,
		0xd8,0x11,0xd8,0x48,0x11,0xd8,0x10,0x1c,0x25,0x44,0x33,0x22,0x11,0x66,0x11,0x1c,0x25,0x11,0x22,0x33,0x44,0x67,0x11,0x18,0x48,0x11,0x1c,0x25,0xa1,0x1a,0x00,0x00
	});*/

	po::slab sl = reg->read();
	boost::optional<prog_loc> maybe_proc = amd64::disassemble(boost::none,sl,po::ref{"ram",0});

	ASSERT_TRUE(!!maybe_proc);
	ASSERT_EQ((*maybe_proc)->procedures().size(), 6);
}
