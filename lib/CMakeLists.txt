set(panopticon_SOURCES src/loc.cc src/value.cc src/region.cc src/marshal.cc
	src/database.cc src/structure.cc src/basic_block.cc src/mnemonic.cc
	src/procedure.cc src/program.cc src/disassembler.cc src/dflow.cc
	src/instr.cc src/interpreter.cc src/avr/avr.cc src/avr/util.cc
	src/code_generator.cc src/amd64/traits.cc
	src/amd64/decode.cc src/amd64/semantics.cc)
set(panopticon_HEADERS include/panopticon/loc.hh include/panopticon/value.hh
	include/panopticon/marshal.hh include/panopticon/digraph.hh
	include/panopticon/region.hh include/panopticon/hash.hh
	include/panopticon/database.hh include/panopticon/structure.hh
	include/panopticon/basic_block.hh include/panopticon/mnemonic.hh
	include/panopticon/procedure.hh include/panopticon/program.hh
	include/panopticon/disassembler.hh include/panopticon/code_generator.hh
	include/panopticon/dflow.hh include/panopticon/instr.hh
	include/panopticon/interpreter.hh include/panopticon/avr/avr.hh
	include/panopticon/avr/util.hh
	include/panopticon/architecture.hh include/panopticon/ensure.hh
	include/panopticon/tree.hh include/panopticon/amd64/amd64.hh
	include/panopticon/amd64/decode.hh include/panopticon/amd64/syntax.hh
	include/panopticon/amd64/semantics.hh include/panopticon/amd64/traits.hh)

set(panopticon_INCLUDE_DIRS ${CMAKE_CURRENT_SOURCE_DIR}/include
	${KyotoCabinet_INCLUDE_DIRS} ${LibArchive_INCLUDE_DIRS}
	${Boost_INCLUDE_DIRS})
set(panopticon_INCLUDE_DIRS ${panopticon_INCLUDE_DIRS} PARENT_SCOPE)

set(panopticon_LIBRARY_DIRS ${LibArchive_LIBRARY_DIRS} ${Boost_LIBRARY_DIRS}
	${KyotoCabinet_LIBRARY_DIRS})
set(panopticon_LIBRARY_DIRS ${panopticon_LIBRARY_DIRS} PARENT_SCOPE)

set(panopticon_LIBRARIES panopticon-shared ${KyotoCabinet_LIBRARIES}
	${LibArchive_LIBRARIES} ${Boost_LIBRARIES})
set(panopticon_LIBRARIES ${panopticon_LIBRARIES} PARENT_SCOPE)

set(panopticon_STATIC_LIBRARIES panopticon-static ${KyotoCabinet_LIBRARIES}
	${LibArchive_LIBRARIES} ${Boost_LIBRARIES})
set(panopticon_STATIC_LIBRARIES ${panopticon_LIBRARIES} PARENT_SCOPE)

set(panopticon_FOUND 1)
set(panopticon_FOUND ${panopticon_FOUND} PARENT_SCOPE)

include_directories(${panopticon_INCLUDE_DIRS})
link_directories(${panopticon_LIBRARY_DIRS})

if(("${CMAKE_CXX_COMPILER_ID}" STREQUAL "GNU" AND UNIX) OR
	("${CMAKE_CXX_COMPILER_ID}" STREQUAL "Clang"))
	add_definitions("-fPIC")
endif()

add_library(panopticon OBJECT ${panopticon_SOURCES} ${panopticon_HEADERS})
add_library(panopticon-shared SHARED $<TARGET_OBJECTS:panopticon>)
add_library(panopticon-static STATIC $<TARGET_OBJECTS:panopticon>)

target_link_libraries(panopticon-shared ${KyotoCabinet_LIBRARIES}
	${LibArchive_LIBRARIES} ${Boost_LIBRARIES})
target_link_libraries(panopticon-static ${KyotoCabinet_LIBRARIES}
	${LibArchive_LIBRARIES} ${Boost_LIBRARIES})

set_target_properties(panopticon-shared PROPERTIES VERSION
	${panopticon_MAJOR}.${panopticon_MINOR}.${panopticon_PATCH} SOVERSION
	${panopticon_MAJOR})
set_target_properties(panopticon-static PROPERTIES VERSION
	${panopticon_MAJOR}.${panopticon_MINOR}.${panopticon_PATCH} SOVERSION
	${panopticon_MAJOR})
set_target_properties(panopticon-shared PROPERTIES OUTPUT_NAME panopticon)
set_target_properties(panopticon-static PROPERTIES OUTPUT_NAME panopticon)

install(TARGETS panopticon-shared LIBRARY DESTINATION ${LIB_INSTALL_DIR}
	RUNTIME DESTINATION bin ARCHIVE DESTINATION ${LIB_INSTALL_DIR})
install(FILES ${panopticon_HEADERS} DESTINATION ${INCLUDE_INSTALL_DIR}/panopticon)

if(UNIX AND NOT APPLE)
	if(NOT PC_INSTALL_DIR)
		EXECUTE_PROCESS(COMMAND dpkg-architecture -qDEB_HOST_MULTIARCH OUTPUT_VARIABLE
			CMAKE_ARCH_TRIPLET OUTPUT_STRIP_TRAILING_WHITESPACE)
		set(PC_INSTALL_DIR "${LIB_INSTALL_DIR}/${CMAKE_ARCH_TRIPLET}/pkgconfig")
	endif()

  configure_file("panopticon.pc.in" "panopticon.pc" @ONLY)
  install(FILES "${CMAKE_CURRENT_BINARY_DIR}/panopticon.pc"
		DESTINATION "${PC_INSTALL_DIR}")
endif()

if("${CMAKE_BUILD_TYPE}" STREQUAL "Debug")
	add_subdirectory("test")
endif()
